<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Speech</title>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            font-size: 48px;
            color: #777;
            user-select: none;
        }
        span {
            position: relative;
            width: 72px;
            height: 72px;
            line-height: 72px;
            text-align: center;
            display: block;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 3px;
        }
    </style>
</head>
<body>
<button onclick="Speech.readCurrentLine();">Start</button>
<input type="file" onchange="loadFromFile();" />
<script>
var Speech = {
    utterance: null,
    init: function (lang) {
        var that = this;

        this.utterance = new SpeechSynthesisUtterance();
        this.utterance.lang = typeof lang === "string" ? lang : "zh-CN";
        this.utterance.rate = 0.75;
        
        this.utterance.onstart = function() {
            that.isSpeaking = true;
        };
        this.utterance.onend = function () {
            that.isSpeaking = false;

            that.currentLine ++;
        };

        this.utterance.onpause = function () {
            //
        };
        this.utterance.onresume = function () {
            that.isSpeaking = true;
        };
    },

    isSpeaking: false,

    lines: [],
    currentLine: -1,
    readCurrentLine: function () {
        if (this.currentLine < 0 || this.currentLine >= this.lines.length) {
            return;
        }

        this.utterance.text = this.lines[this.currentLine];
        console.log(this.utterance.text);
        speechSynthesis.speak(this.utterance);
    },
    speak: function (s) {
        this.lines = [];

        var a = s.split("ã€‚");
        for (var i = 0; i < a.length; i ++) {
            var t = a[i].trim();
            if (t) {
                this.lines.push(t);
            }
        }

        if (this.lines.length === 0) {
            return;
        }

        this.currentLine = 0;
        this.readCurrentLine();
    }
};

Speech.init();

function loadFromFile() {
    var fi = document.querySelector("input");
    if (fi.files.length === 0) {
        return;
    }

    var fr = new FileReader();
    fr.onload = function () {
        Speech.speak(fr.result);
    };
    fr.readAsText(fi.files[0]);
};
</script>
</body>
</html>